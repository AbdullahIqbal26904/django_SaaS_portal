{% extends "base.html" %}

{% block title %}{{ department.name }} - SaaS Portal{% endblock %}
{% block header_title %}Department: {{ department.name }}{% endblock %}
{% block nav_departments_active %}active{% endblock %}

{% block content %}
<div class="content-card">
    <div class="card-title">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Department Details</h2>
            {% if is_root_admin or is_department_admin %}
            <div>
                <a href="{% url 'edit_department' department.department_id %}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Edit Department
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div style="margin-bottom: 30px;">
        <p><strong>Name:</strong> {{ department.name }}</p>
        <p><strong>Description:</strong> {{ department.description }}</p>
        <p><strong>Created At:</strong> {{ department.created_at|date:"F d, Y" }}</p>
    </div>
    
    <div class="card-title">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Department Administrators</h3>
            {% if is_root_admin %}
            <button id="addAdminBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Admin
            </button>
            {% endif %}
        </div>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Assigned At</th>
            </tr>
        </thead>
        <tbody>
            {% for admin in admins %}
            <tr>
                <td>{{ admin.user.full_name }}</td>
                <td>{{ admin.user.email }}</td>
                <td>{{ admin.assigned_at|date:"M d, Y" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3">No administrators assigned.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div class="card-title" style="margin-top: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Department Members</h3>
            {% if is_root_admin or is_department_admin %}
            <button id="addUserBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add User
            </button>
            {% endif %}
        </div>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Assigned At</th>
                {% if is_root_admin or is_department_admin %}
                <th>Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for member in members %}
            <tr>
                <td>{{ member.user.full_name }}</td>
                <td>{{ member.user.email }}</td>
                <td>{{ member.assigned_at|date:"M d, Y" }}</td>
                {% if is_root_admin or is_department_admin %}
                <td>
                    <button class="btn btn-danger btn-sm remove-user-btn" data-user-id="{{ member.user.user_id }}">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </td>
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{% if is_root_admin or is_department_admin %}4{% else %}3{% endif %}">
                    No members assigned.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal for adding admin -->
<div id="addAdminModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="margin: 100px auto; width: 400px; background-color: white; padding: 20px; border-radius: 8px;">
        <h3>Add Department Admin</h3>
        <div class="form-group">
            <label class="form-label">User Email</label>
            <input type="email" id="adminEmail" class="form-control" placeholder="Enter user email">
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="closeAdminModal" class="btn btn-secondary">Cancel</button>
            <button id="saveAdmin" class="btn btn-primary">Add Admin</button>
        </div>
    </div>
</div>

<!-- Modal for adding user -->
<div id="addUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="margin: 100px auto; width: 400px; background-color: white; padding: 20px; border-radius: 8px;">
        <h3>Add Department User</h3>
        <div class="form-group">
            <label class="form-label">User Email</label>
            <input type="email" id="userEmail" class="form-control" placeholder="Enter user email">
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="closeUserModal" class="btn btn-secondary">Cancel</button>
            <button id="saveUser" class="btn btn-primary">Add User</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Add admin button functionality
    const addAdminBtn = document.getElementById('addAdminBtn');
    if (addAdminBtn) {
        addAdminBtn.addEventListener('click', function() {
            const userEmail = prompt("Enter user email to add as admin:");
            if (userEmail) {
                // Make API call to add admin
                fetch(`/department/{{ department.department_id }}/add-admin/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ user_email: userEmail })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert(data.message);
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while adding admin');
                });
            }
        });
    }
    
    // Add user button functionality
    const addUserBtn = document.getElementById('addUserBtn');
    if (addUserBtn) {
        addUserBtn.addEventListener('click', function() {
            const userEmail = prompt("Enter user email to add to department:");
            if (userEmail) {
                // Make API call to add user
                fetch(`/department/{{ department.department_id }}/add-user/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ user_email: userEmail })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert(data.message);
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while adding user');
                });
            }
        });
    }
    
    // Remove user buttons functionality
    const removeUserBtns = document.querySelectorAll('.remove-user-btn');
    removeUserBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const userId = this.dataset.userId;
            if (confirm("Are you sure you want to remove this user from the department?")) {
                // Make API call to remove user
                fetch(`/department/{{ department.department_id }}/remove-user/${userId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert(data.message);
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while removing user');
                });
            }
        });
    });
});
</script>
{% endblock %}
