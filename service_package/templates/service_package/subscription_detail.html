{% extends "base.html" %}

{% block title %}Subscription Details - SaaS Portal{% endblock %}
{% block header_title %}Subscription Details{% endblock %}
{% block nav_subscriptions_active %}active{% endblock %}

{% block content %}
<div class="content-card">
    <div class="card-title">
        <h2>Subscription Details</h2>
    </div>
    
    <div style="margin-bottom: 30px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <div>
                <h3>{{ subscription.service_package.name }}</h3>
                <p style="color: var(--secondary-color);">{{ subscription.service_package.description|truncatechars:100 }}</p>
            </div>
            <div style="text-align: right;">
                <div class="badge 
                    {% if subscription.status == 'active' %}badge-success
                    {% elif subscription.status == 'expired' %}badge-danger
                    {% elif subscription.status == 'cancelled' %}badge-warning
                    {% else %}badge-info{% endif %}">
                    {{ subscription.status|title }}
                </div>
                <div style="margin-top: 10px; font-size: 24px; font-weight: bold;">
                    ${{ subscription.service_package.price }}
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
            <div>
                <strong>Department:</strong> {{ subscription.department.name }}
            </div>
            <div>
                <strong>Billing Cycle:</strong> {{ subscription.service_package.billing_cycle|title }}
            </div>
            <div>
                <strong>Start Date:</strong> {{ subscription.start_date|date:"F d, Y" }}
            </div>
            <div>
                <strong>End Date:</strong> {{ subscription.end_date|date:"F d, Y" }}
            </div>
        </div>
    </div>
    
    <div class="card-title" style="margin-top: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Users with Access</h3>
            {% if is_root_admin or is_department_admin %}
            <button id="addAccessBtn" class="btn btn-primary">
                <i class="fas fa-plus"></i> Grant Access
            </button>
            {% endif %}
        </div>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>User</th>
                <th>Email</th>
                <th>Granted At</th>
                {% if is_root_admin or is_department_admin %}
                <th>Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for access in user_access %}
            <tr>
                <td>{{ access.user.full_name }}</td>
                <td>{{ access.user.email }}</td>
                <td>{{ access.granted_at|date:"M d, Y" }}</td>
                {% if is_root_admin or is_department_admin %}
                <td>
                    <button class="btn btn-danger btn-sm revoke-access-btn" data-user-id="{{ access.user.user_id }}">
                        <i class="fas fa-times"></i> Revoke
                    </button>
                </td>
                {% endif %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="{% if is_root_admin or is_department_admin %}4{% else %}3{% endif %}">
                    No users have been granted access to this subscription yet.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div class="card-title" style="margin-top: 30px;">
        <h3>Transaction History</h3>
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>Transaction ID</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr>
                <td>{{ transaction.transaction_id }}</td>
                <td>${{ transaction.amount }}</td>
                <td>{{ transaction.payment_date|date:"M d, Y" }}</td>
                <td>
                    {% if transaction.status == 'completed' %}
                    <span class="badge badge-success">Completed</span>
                    {% elif transaction.status == 'pending' %}
                    <span class="badge badge-info">Pending</span>
                    {% elif transaction.status == 'failed' %}
                    <span class="badge badge-danger">Failed</span>
                    {% else %}
                    <span class="badge badge-warning">{{ transaction.status|title }}</span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">
                    No transaction records found for this subscription.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal for granting access -->
<div id="addAccessModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="margin: 100px auto; width: 400px; background-color: white; padding: 20px; border-radius: 8px;">
        <h3>Grant Service Access</h3>
        <div class="form-group">
            <label class="form-label">User Email</label>
            <input type="email" id="userEmail" class="form-control" placeholder="Enter user email">
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="closeAccessModal" class="btn btn-secondary">Cancel</button>
            <button id="grantAccess" class="btn btn-primary">Grant Access</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add Access Modal
        const addAccessBtn = document.getElementById('addAccessBtn');
        const addAccessModal = document.getElementById('addAccessModal');
        const closeAccessModal = document.getElementById('closeAccessModal');
        
        if (addAccessBtn) {
            addAccessBtn.addEventListener('click', function() {
                addAccessModal.style.display = 'block';
            });
        }
        
        if (closeAccessModal) {
            closeAccessModal.addEventListener('click', function() {
                addAccessModal.style.display = 'none';
            });
        }
        
        // Grant Access Button
        const grantAccessBtn = document.getElementById('grantAccess');
        if (grantAccessBtn) {
            grantAccessBtn.addEventListener('click', async function() {
                const email = document.getElementById('userEmail').value;
                if (!email) return;
                
                try {
                    // API call would go here
                    // Simplified for demo purposes
                    alert('Access granted successfully');
                    addAccessModal.style.display = 'none';
                    location.reload(); // Reload to see changes
                } catch (error) {
                    alert('Error granting access: ' + error);
                }
            });
        }
        
        // Revoke Access Buttons
        const revokeAccessBtns = document.querySelectorAll('.revoke-access-btn');
        revokeAccessBtns.forEach(button => {
            button.addEventListener('click', async function() {
                if (confirm('Are you sure you want to revoke access for this user?')) {
                    const userId = button.getAttribute('data-user-id');
                    
                    try {
                        // API call would go here
                        // Simplified for demo purposes
                        alert('Access revoked successfully');
                        location.reload(); // Reload to see changes
                    } catch (error) {
                        alert('Error revoking access: ' + error);
                    }
                }
            });
        });
    });
</script>
{% endblock %}
